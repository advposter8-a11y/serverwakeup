name: Wake Render Sites (Smart Start/Stop + Daily WhatsApp Report)

on:
  schedule:
    - cron: '*/30 * * * *'   # Ù‡Ø± Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ (UTC)
  workflow_dispatch: {}       # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²

jobs:
  wake:
    runs-on: ubuntu-latest
    steps:
      - name: Restore state cache
        uses: actions/cache@v3
        with:
          path: .cache/
          key: site-state-${{ runner.os }}-v3
          restore-keys: |
            site-state-${{ runner.os }}-v3

      - name: Wake Render Sites with Smart Timing
        run: |
          set -e
          mkdir -p .cache
          state_file=".cache/site_status.log"
          meta_file=".cache/last_sent.log"
          touch "$state_file" "$meta_file"

          # ðŸ•’ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Øª Ø§ÛŒØ±Ø§Ù† (UTC+3:30)
          current_utc_hour=$(date -u +"%H")
          current_utc_minute=$(date -u +"%M")
          total_utc_minutes=$((10#$current_utc_hour * 60 + 10#$current_utc_minute))
          total_iran_minutes=$(( (total_utc_minutes + 210) % 1440 )) # +3h30m offset

          iran_hour=$((total_iran_minutes / 60))
          iran_minute=$((total_iran_minutes % 60))
          printf "ðŸ•’ Iran time: %02d:%02d\n" $iran_hour $iran_minute

          phone="989197934854"
          apikey="4287648"
          sites=(
            "https://n8n-vn5b.onrender.com/"
            "https://cl-s5ej.onrender.com/"
            "https://bitbrief.click/"
            "https://trrigeractive.onrender.com/"
            "https://n8nyoutube-ullx.onrender.com/"
            "https://n8nrunner.onrender.com/"
            "https://kadoo.click/"
            "https://crawl-f2mb.onrender.com/"
            "https://server2-sy6g.onrender.com/health"
            "https://neurobackend.onrender.com/"
            "https://license-krks.onrender.com/"
            "https://api1-nsqh.onrender.com/"
          )

          # ðŸ’¤ Ø¨Ø§Ø²Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª: 05:00â€“09:30 Ø§ÛŒØ±Ø§Ù†
          start_minutes=$((9 * 60 + 30))
          stop_minutes=$((5 * 60))

          function send_msg() {
            msg="$1"
            echo "$msg"
            curl -G --data-urlencode "phone=$phone" \
                  --data-urlencode "text=$msg" \
                  --data-urlencode "apikey=$apikey" \
                  "https://api.callmebot.com/whatsapp.php"
          }

          # âœ… Ù¾ÛŒØ§Ù… Ø´Ø±ÙˆØ¹ (ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ø¯Ø± Ø±ÙˆØ²)
          if [ $total_iran_minutes -ge $start_minutes ] && [ $total_iran_minutes -lt $((start_minutes + 5)) ]; then
            if ! grep -q "$(date +%Y-%m-%d)-start" "$meta_file"; then
              send_msg "ðŸš€ Wake Bot started at 09:30 Iran time. Monitoring all Render servers now!"
              echo "$(date +%Y-%m-%d)-start" >> "$meta_file"
            fi
          fi

          # ðŸ›‘ Ù¾ÛŒØ§Ù… ØªÙˆÙ‚Ù (ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ø¯Ø± Ø±ÙˆØ²)
          if [ $total_iran_minutes -ge $stop_minutes ] && [ $total_iran_minutes -lt $((stop_minutes + 5)) ]; then
            if ! grep -q "$(date +%Y-%m-%d)-stop" "$meta_file"; then
              send_msg "ðŸ›‘ Wake Bot stopped at 05:00 Iran time. Entering rest mode (Render cooldown)."
              echo "$(date +%Y-%m-%d)-stop" >> "$meta_file"
            fi
          fi

          # ðŸ’¤ Ø§Ú¯Ø± Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø³ØªØ±Ø§Ø­Øª Ù‡Ø³ØªØŒ Ú†Ú© Ù†Ú©Ù†
          if [ $total_iran_minutes -ge $stop_minutes ] && [ $total_iran_minutes -lt $start_minutes ]; then
            echo "ðŸ˜´ Sleep mode (05:00â€“09:30 Iran). Skipping all checks."
            exit 0
          fi

          # ðŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ú†Ú© Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§
          echo "ðŸŸ¢ Active hours. Checking site status..."
          summary="ðŸ“Š Render Site Report:\n\n"

          MAX_ATTEMPTS=15
          for site in "${sites[@]}"; do
            echo "ðŸ”¹ Checking $site"
            success=false
            for i in $(seq 1 $MAX_ATTEMPTS); do
              # Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ ÙˆØ§Ù‚Ø¹ÛŒ
              status_code=$(curl -s -o /dev/null -w "%{http_code}" "$site")
              body_preview=$(curl -s --max-time 8 "$site" | head -n 3)

              if [[ "$status_code" =~ ^(200|301|302)$ ]] && [[ ! "$body_preview" =~ "Render Internal Error" ]] && [[ ! "$body_preview" =~ "starting" ]] && [[ ! "$body_preview" =~ "Booting" ]]; then
                success=true
                break
              fi

              sleep 20
            done

            if [ "$success" = true ]; then
              summary+="$site â†’ âœ… UP\n"
              grep -v "^$site " "$state_file" > "$state_file.tmp" || true
              mv "$state_file.tmp" "$state_file"
              echo "$site up" >> "$state_file"
            else
              summary+="$site â†’ âŒ DOWN\n"
              grep -v "^$site " "$state_file" > "$state_file.tmp" || true
              mv "$state_file.tmp" "$state_file"
              echo "$site down" >> "$state_file"
            fi
          done

          # ðŸ•š Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø³Ø§Ø¹Øª Û²Û³:ÛµÛ° Ø§ÛŒØ±Ø§Ù†
          if [ $iran_hour -eq 23 ] && [ $iran_minute -ge 50 ] && [ $iran_minute -lt 55 ]; then
            if ! grep -q "$(date +%Y-%m-%d)-report" "$meta_file"; then
              send_msg "ðŸ•“ Daily Report (23:50 Iran time)\n\n$summary"
              echo "$(date +%Y-%m-%d)-report" >> "$meta_file"
            fi
          fi

      - name: Save cache
        uses: actions/cache@v3
        with:
          path: .cache/
          key: site-state-${{ runner.os }}-v3
