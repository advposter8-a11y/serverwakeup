name: Wake Render Sites (Daily WhatsApp Report + Auto Wake)

on:
  schedule:
    - cron: '*/30 * * * *'  # Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø± Ù†ÛŒÙ…â€ŒØ³Ø§Ø¹Øª (UTC)
  workflow_dispatch: {}

jobs:
  wake:
    runs-on: ubuntu-latest
    steps:
      # ğŸ§© Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ Ùˆ flags
      - name: Restore site status cache
        uses: actions/cache@v3
        with:
          path: .cache
          key: site-status-${{ runner.os }}-v1
          restore-keys: |
            site-status-${{ runner.os }}-v1

      # ğŸš€ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§ØµÙ„ÛŒ
      - name: Wake and Monitor Render Sites
        run: |
          set -e
          mkdir -p .cache
          state_file=".cache/site_status.log"
          sent_file=".cache/sent_flags.log"
          touch "$state_file" "$sent_file"

          # ---------- Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ flags Ø³Ø§Ø¹Øª 00:00 ----------
          current_hour=$(date -u +"%H")
          current_minute=$(date -u +"%M")
          if [ $current_hour -eq 20 ] && [ $current_minute -ge 30 ] && [ ! -f ".cache/flags_cleared" ]; then
            echo "ğŸ§¹ Clearing daily flags for a new day..."
            rm -f "$sent_file"
            touch "$sent_file"
            touch ".cache/flags_cleared"
          fi
          if [ $current_hour -ne 20 ]; then
            rm -f ".cache/flags_cleared"
          fi

          # ---------- Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Øª Ø§ÛŒØ±Ø§Ù† (UTC+3:30) ----------
          current_hour_iran=$((10#$current_hour + 3))
          current_minute_iran=$((10#$current_minute + 30))
          if [ $current_minute_iran -ge 60 ]; then
            current_minute_iran=$((current_minute_iran - 60))
            current_hour_iran=$((current_hour_iran + 1))
          fi
          current_hour_iran=$((current_hour_iran % 24))
          echo "ğŸ•’ Iran time: ${current_hour_iran}:${current_minute_iran}"

          phone="989197934854"
          apikey="4287648"
          summary="ğŸ“Š Daily Render Status Report:\n\n"

          # ---------- Ù¾ÛŒØ§Ù… Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø³Ø§Ø¹Øª 09:30 ----------
          if [ $current_hour_iran -eq 9 ] && [ $current_minute_iran -eq 30 ]; then
            if ! grep -q "start_sent" "$sent_file"; then
              echo "ğŸ“© Sending start-of-day notification..."
              curl -G --data-urlencode "phone=$phone" \
                    --data-urlencode "text=ğŸŸ¢ Bot started monitoring sites at 09:30 Iran time." \
                    --data-urlencode "apikey=$apikey" \
                    "https://api.callmebot.com/whatsapp.php"
              echo "start_sent" >> "$sent_file"
            else
              echo "âœ… Start-of-day message already sent."
            fi
          fi

          # ---------- Ù¾ÛŒØ§Ù… ØªÙˆÙ‚Ù Ú©Ø§Ø± Ø³Ø§Ø¹Øª 05:00 ----------
          if [ $current_hour_iran -eq 5 ] && [ $current_minute_iran -eq 0 ]; then
            if ! grep -q "stop_sent" "$sent_file"; then
              echo "ğŸ“© Sending stop-of-day notification..."
              curl -G --data-urlencode "phone=$phone" \
                    --data-urlencode "text=ğŸ˜´ Bot is stopping monitoring sites until 09:30 Iran time." \
                    --data-urlencode "apikey=$apikey" \
                    "https://api.callmebot.com/whatsapp.php"
              echo "stop_sent" >> "$sent_file"
            else
              echo "âœ… Stop-of-day message already sent."
            fi
          fi

          # ---------- Ø¨Ø§Ø²Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª (Û°Ûµ:Û°Û° ØªØ§ Û°Û¹:Û³Û°) ----------
          if [ $current_hour_iran -ge 5 ] && [ $current_hour_iran -lt 9 ]; then
            echo "ğŸ˜´ Sleep time (05:00â€“09:30 Iran). Skipping check."
            exit 0
          elif [ $current_hour_iran -eq 9 ] && [ $current_minute_iran -lt 30 ]; then
            echo "ğŸ˜´ Still rest time (before 09:30). Skipping check."
            exit 0
          fi

          echo "ğŸŸ¢ Active hours. Checking all Render sites..."

          # ---------- Ù„ÛŒØ³Øª Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ ----------
          sites=(
            "https://n8n-vn5b.onrender.com/"
            "https://cl-s5ej.onrender.com/"
            "https://bitbrief.click/"
            "https://trrigeractive.onrender.com/"
            "https://n8nyoutube-ullx.onrender.com/"
            "https://n8nrunner.onrender.com/"
            "https://kadoo.click/"
            "https://crawl-f2mb.onrender.com/"
            "https://server2-sy6g.onrender.com/health"
            "https://neurobackend.onrender.com/"
            "https://license-krks.onrender.com/"
            "https://api1-nsqh.onrender.com/"
          )

          # ---------- Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ ----------
          for site in "${sites[@]}"; do
            echo "ğŸ”¹ Checking $site"
            success=false
            for i in {1..20}; do
              echo "Attempt #$i for $site ..."
              if curl -s -I "$site" | grep -q "200\\|301\\|302"; then
                echo "âœ… $site is UP"
                success=true
                break
              fi
              echo "âš ï¸ $site still down. Waiting 30s..."
              sleep 30
            done

            # Ø«Ø¨Øª ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ
            if [ "$success" = true ]; then
              grep -v "^$site " "$state_file" > "$state_file.tmp" || true
              mv "$state_file.tmp" "$state_file" || true
              echo "$site up" >> "$state_file"
              summary+="$site â†’ âœ… UP\n"
            else
              grep -v "^$site " "$state_file" > "$state_file.tmp" || true
              mv "$state_file.tmp" "$state_file" || true
              echo "$site down" >> "$state_file"
              summary+="$site â†’ âŒ DOWN\n"
            fi
          done

          # ---------- Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø³Ø§Ø¹Øª 23:50 ----------
          if [ "$current_hour_iran" -eq 23 ] && [ "$current_minute_iran" -ge 50 ]; then
            if ! grep -q "daily_sent" "$sent_file"; then
              echo "ğŸ“¨ Sending daily WhatsApp report..."
              curl -G --data-urlencode "phone=$phone" \
                    --data-urlencode "text=$summary" \
                    --data-urlencode "apikey=$apikey" \
                    "https://api.callmebot.com/whatsapp.php"
              echo "daily_sent" >> "$sent_file"
            else
              echo "âœ… Daily report already sent."
            fi
          else
            echo "â³ Not time for daily summary yet."
          fi

      # ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª
      - name: Save site status cache
        uses: actions/cache@v3
        with:
          path: .cache
          key: site-status-${{ runner.os }}-v1
