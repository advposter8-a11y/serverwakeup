name: Wake Render Sites (WhatsApp Alerts + Recovery + Daily Summary)

on:
  schedule:
    - cron: '*/30 * * * *'  # Ù‡Ø± Ù†ÛŒÙ… Ø³Ø§Ø¹Øª UTC
  workflow_dispatch: {}

jobs:
  wake:
    runs-on: ubuntu-latest
    steps:
      # ================= Restore cache =================
      - name: Restore site status cache
        uses: actions/cache@v3
        with:
          path: .cache/site_status.log
          key: site-status-${{ runner.os }}-v1
          restore-keys: |
            site-status-${{ runner.os }}-v1

      # ================= Wake Script =================
      - name: Wake and Monitor Render Sites
        run: |
          set -e
          mkdir -p .cache
          state_file=".cache/site_status.log"
          touch "$state_file"

          # ---------- Ø²Ù…Ø§Ù† Ø§ÛŒØ±Ø§Ù† ----------
          current_hour=$(date -u +"%H")
          current_minute=$(date -u +"%M")
          current_hour_iran=$((10#$current_hour + 3))
          current_minute_iran=$((10#$current_minute + 30))
          if [ $current_minute_iran -ge 60 ]; then
            current_minute_iran=$((current_minute_iran - 60))
            current_hour_iran=$((current_hour_iran + 1))
          fi
          current_hour_iran=$((current_hour_iran % 24))
          echo "ğŸ•’ Current Iran time: ${current_hour_iran}:${current_minute_iran}"

          # ---------- Ø¨Ø§Ø²Ù‡ Ø§Ø³ØªØ±Ø§Ø­Øª: 05:00â€“09:30 ----------
          if [ $current_hour_iran -ge 5 ] && [ $current_hour_iran -lt 9 ]; then
              echo "ğŸ›Œ Outside active hours (05:00â€“09:30). Exiting."
              exit 0
          elif [ $current_hour_iran -eq 9 ] && [ $current_minute_iran -lt 30 ]; then
              echo "ğŸ›Œ Outside active hours (05:00â€“09:30). Exiting."
              exit 0
          fi
          echo "ğŸŸ¢ Inside active hours. Running workflow..."

          # ---------- Ù„ÛŒØ³Øª Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ ----------
          sites=(
            "https://n8n-vn5b.onrender.com/"
            "https://cl-s5ej.onrender.com/"
            "https://bitbrief.click/"
            "https://trrigeractive.onrender.com/"
            "https://n8nyoutube-ullx.onrender.com/"
            "https://n8nrunner.onrender.com/"
            "https://kadoo.click/"
            "https://crawl-f2mb.onrender.com/"
            "https://server2-sy6g.onrender.com/health"
            "https://neurobackend.onrender.com/"
            "https://license-krks.onrender.com/"
            "https://api1-nsqh.onrender.com/"
          )

          phone="989197934854"
          apikey="4287648"

          summary="Daily Status Summary:\n"

          # ---------- Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ ----------
          for site in "${sites[@]}"; do
              echo "ğŸ”¹ Checking $site ..."
              success=false
              for i in {1..10}; do
                  if curl -s -I "$site" | grep -q "200\|301\|302"; then
                      success=true
                      break
                  fi
                  echo "Try #$i failed. Retrying in 15s..."
                  sleep 15
              done

              prev_status=$(grep "^$site " "$state_file" | awk '{print $2}' || echo "")

              if [ "$success" = true ]; then
                  if [ "$prev_status" = "down" ]; then
                      msg="âœ… $site is back online!"
                      echo "Sending recovery alert: $msg"
                      curl -G --data-urlencode "phone=$phone" \
                            --data-urlencode "text=$msg" \
                            --data-urlencode "apikey=$apikey" \
                            "https://api.callmebot.com/whatsapp.php"
                  fi
                  grep -v "^$site " "$state_file" > "$state_file.tmp" || true
                  mv "$state_file.tmp" "$state_file" || true
                  echo "$site up" >> "$state_file"
                  echo "$site status: UP"
                  summary+="$site: UP\n"
              else
                  if [ "$prev_status" != "down" ]; then
                      msg="âš ï¸ Render site DOWN: $site"
                      echo "Sending alert: $msg"
                      curl -G --data-urlencode "phone=$phone" \
                            --data-urlencode "text=$msg" \
                            --data-urlencode "apikey=$apikey" \
                            "https://api.callmebot.com/whatsapp.php"
                  fi
                  grep -v "^$site " "$state_file" > "$state_file.tmp" || true
                  mv "$state_file.tmp" "$state_file" || true
                  echo "$site down" >> "$state_file"
                  echo "$site status: DOWN"
                  summary+="$site: DOWN\n"
              fi
          done

          # ---------- Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®Ù„Ø§ØµÙ‡ Ø±ÙˆØ²Ø§Ù†Ù‡ ----------
          # Ø§Ú¯Ø± Ø³Ø§Ø¹Øª 23:59 Ø§ÛŒØ±Ø§Ù† Ø§Ø³ØªØŒ Ù¾ÛŒØ§Ù… Ø®Ù„Ø§ØµÙ‡ Ø¨ÙØ±Ø³Øª
          if [ "$current_hour_iran" -eq 23 ] && [ "$current_minute_iran" -ge 50 ]; then
              echo "ğŸ“© Sending daily summary via WhatsApp..."
              curl -G --data-urlencode "phone=$phone" \
                    --data-urlencode "text=$summary" \
                    --data-urlencode "apikey=$apikey" \
                    "https://api.callmebot.com/whatsapp.php"
          fi

      # ================= Save cache =================
      - name: Save site status cache
        uses: actions/cache@v3
        with:
          path: .cache/site_status.log
          key: site-status-${{ runner.os }}-v1
