name: Wake Render Sites (Daily WhatsApp Report + Auto Wake - Robust)

on:
  schedule:
    - cron: '*/30 * * * *'  # Ÿáÿ± ŸÜ€åŸÖ‚Äåÿ≥ÿßÿπÿ™ (UTC)
  workflow_dispatch: {}

jobs:
  wake:
    runs-on: ubuntu-latest
    steps:
      # Persist entire .cache folder (site status + sent flags)
      - name: Restore cache and flags
        uses: actions/cache@v3
        with:
          path: .cache
          key: site-status-${{ runner.os }}-v2
          restore-keys: |
            site-status-${{ runner.os }}-v2

      - name: Wake and Monitor Render Sites
        run: |
          set -euo pipefail
          mkdir -p .cache
          state_file=".cache/site_status.log"
          sent_file=".cache/sent_flags.log"
          touch "$state_file" "$sent_file"

          # ---------- compute UTC and Iran time & date ----------
          utc_now="$(date -u '+%Y-%m-%d %H:%M')"
          current_hour_utc=$(date -u +"%H")
          current_minute_utc=$(date -u +"%M")
          # Iran = UTC + 3:30
          current_hour_iran=$((10#$current_hour_utc + 3))
          current_minute_iran=$((10#$current_minute_utc + 30))
          if [ $current_minute_iran -ge 60 ]; then
            current_minute_iran=$((current_minute_iran - 60))
            current_hour_iran=$((current_hour_iran + 1))
          fi
          current_hour_iran=$((current_hour_iran % 24))
          # Iran date for flagging (YYYY-MM-DD)
          # get UTC date and convert to Iran date safely:
          iran_date=$(date -u -d "${utc_now} +3 hours 30 minutes" '+%Y-%m-%d')

          echo "UTC now: $utc_now"
          printf "Iran time: %s:%02d  (date %s)\n" "$current_hour_iran" "$current_minute_iran" "$iran_date"

          phone="989197934854"
          apikey="4287648"

          # helper: check and write flag for today
          has_flag_for_today() {
            grep -q "^$1:$iran_date\$" "$sent_file" 2>/dev/null || return 1
          }
          write_flag_for_today() {
            # remove previous same-key entries then append key:date
            grep -v "^$1:" "$sent_file" > "$sent_file.tmp" || true
            mv "$sent_file.tmp" "$sent_file" || true
            echo "$1:$iran_date" >> "$sent_file"
          }

          # ---------- SEND STOP MESSAGE around 05:00 Iran (one-time per day) ----------
          # window 05:00 - 05:04 (to tolerate small cron delays)
          if [ "$current_hour_iran" -eq 5 ] && [ $current_minute_iran -ge 0 ] && [ $current_minute_iran -le 4 ]; then
            if ! has_flag_for_today "stop_sent"; then
              echo "Sending STOP message (05:00 window)..."
              curl -s -G --data-urlencode "phone=$phone" \
                    --data-urlencode "text=üõë Bot stopped monitoring at 05:00 Iran time for daily rest (05:00‚Äì09:30)." \
                    --data-urlencode "apikey=$apikey" \
                    "https://api.callmebot.com/whatsapp.php" || true
              write_flag_for_today "stop_sent"
            else
              echo "Stop message already sent today."
            fi
            # ensure we do not run checks during rest window
            echo "Rest window active ‚Äî exiting."
            exit 0
          fi

          # ---------- Rest window: 05:00 <= t < 09:30 ----------
          if [ $current_hour_iran -ge 5 ] && [ $current_hour_iran -lt 9 ]; then
            echo "Rest period (05:00‚Äì09:30). Exiting."
            exit 0
          elif [ $current_hour_iran -eq 9 ] && [ $current_minute_iran -lt 30 ]; then
            echo "Rest period (before 09:30). Exiting."
            exit 0
          fi

          # ---------- SEND START MESSAGE around 09:30 Iran (one-time per day) ----------
          # window 09:30 - 09:39 (to tolerate cron delays)
          if [ "$current_hour_iran" -eq 9 ] && [ $current_minute_iran -ge 30 ] && [ $current_minute_iran -le 39 ]; then
            if ! has_flag_for_today "start_sent"; then
              echo "Sending START message (09:30 window)..."
              curl -s -G --data-urlencode "phone=$phone" \
                    --data-urlencode "text=üöÄ Bot started daily monitoring at ~09:30 Iran time." \
                    --data-urlencode "apikey=$apikey" \
                    "https://api.callmebot.com/whatsapp.php" || true
              write_flag_for_today "start_sent"
            else
              echo "Start message already sent today."
            fi
          fi

          echo "Active hours confirmed ‚Äî running site checks now."

          # ---------- sites list ----------
          sites=(
            "https://n8n-vn5b.onrender.com/"
            "https://cl-s5ej.onrender.com/"
            "https://bitbrief.click/"
            "https://trrigeractive.onrender.com/"
            "https://n8nyoutube-ullx.onrender.com/"
            "https://n8nrunner.onrender.com/"
            "https://kadoo.click/"
            "https://crawl-f2mb.onrender.com/"
            "https://server2-sy6g.onrender.com/health"
            "https://neurobackend.onrender.com/"
            "https://license-krks.onrender.com/"
            "https://api1-nsqh.onrender.com/"
          )

          # summary accumulates statuses (for daily report)
          summary="üìä Daily Render Status Report ($iran_date):\n\n"

          # ---------- PARAMETERS you can tune ----------
          MAX_ATTEMPTS=10      # number of retries per site (reduced for timely runs)
          SLEEP_BETWEEN=15     # seconds between attempts

          # ---------- iterate sites ----------
          for site in "${sites[@]}"; do
            echo "Checking: $site"
            attempts=0
            success=false
            while [ $attempts -lt $MAX_ATTEMPTS ]; do
              attempts=$((attempts+1))
              # use -m 10 to bound curl time per try
              if curl -s -I -m 10 "$site" | grep -q -E "HTTP/[0-9.]+ (200|301|302)"; then
                echo "  -> UP (after $attempts attempt(s))"
                success=true
                break
              else
                echo "  -> attempt $attempts failed, sleeping ${SLEEP_BETWEEN}s..."
                sleep $SLEEP_BETWEEN
              fi
            done

            # update state file (replace previous line for this site)
            grep -v "^$site " "$state_file" > "$state_file.tmp" || true
            mv "$state_file.tmp" "$state_file" || true
            if [ "$success" = true ]; then
              echo "$site up" >> "$state_file"
              summary+="$site ‚Üí ‚úÖ UP (after ${attempts} try)\n"
            else
              echo "$site down" >> "$state_file"
              summary+="$site ‚Üí ‚ùå DOWN (after ${attempts} tries)\n"
            fi
          done

          # ---------- DAILY SUMMARY at 23:50 Iran (one-time) ----------
          if [ "$current_hour_iran" -eq 23 ] && [ $current_minute_iran -ge 50 ]; then
            if ! has_flag_for_today "daily_sent"; then
              echo "Sending daily summary..."
              curl -s -G --data-urlencode "phone=$phone" \
                    --data-urlencode "text=$summary" \
                    --data-urlencode "apikey=$apikey" \
                    "https://api.callmebot.com/whatsapp.php" || true
              write_flag_for_today "daily_sent"
            else
              echo "Daily summary already sent today."
            fi
          else
            echo "Not time for daily summary yet."
          fi

      - name: Save cache and flags
        uses: actions/cache@v3
        with:
          path: .cache
          key: site-status-${{ runner.os }}-v2
