name: Wake Render Sites (Daily WhatsApp Report + Auto Wake - Robust)

on:
  schedule:
    - cron: '*/30 * * * *'  # Ÿáÿ± ŸÜ€åŸÖ‚Äåÿ≥ÿßÿπÿ™ (UTC)
  workflow_dispatch: {}

jobs:
  wake:
    runs-on: ubuntu-latest
    steps:
      # Persist entire .cache folder (site status + sent flags)
      - name: Restore cache and flags
        uses: actions/cache@v3
        with:
          path: .cache
          key: site-status-${{ runner.os }}-v2
          restore-keys: |
            site-status-${{ runner.os }}-v2

      - name: Wake and Monitor Render Sites
        run: |
          set -euo pipefail
          mkdir -p .cache
          state_file=".cache/site_status.log"
          sent_file=".cache/sent_flags.log"
          touch "$state_file" "$sent_file"

          # ---------- compute UTC and Iran time & date ----------
          utc_now="$(date -u '+%Y-%m-%d %H:%M')"
          current_hour_utc=$(date -u +"%H")
          current_minute_utc=$(date -u +"%M")
          # Iran = UTC + 3:30
          current_hour_iran=$((10#$current_hour_utc + 3))
          current_minute_iran=$((10#$current_minute_utc + 30))
          if [ $current_minute_iran -ge 60 ]; then
            current_minute_iran=$((current_minute_iran - 60))
            current_hour_iran=$((current_hour_iran + 1))
          fi
          current_hour_iran=$((current_hour_iran % 24))
          iran_date=$(date -u -d "${utc_now} +3 hours 30 minutes" '+%Y-%m-%d')

          echo "UTC now: $utc_now"
          printf "Iran time: %s:%02d  (date %s)\n" "$current_hour_iran" "$current_minute_iran" "$iran_date"

          phone="989197934854"
          apikey="4287648"

          # helper: check and write flag for today
          has_flag_for_today() {
            grep -q "^$1:$iran_date\$" "$sent_file" 2>/dev/null || return 1
          }
          write_flag_for_today() {
            grep -v "^$1:" "$sent_file" > "$sent_file.tmp" || true
            mv "$sent_file.tmp" "$sent_file" || true
            echo "$1:$iran_date" >> "$sent_file"
          }

          # ---------- REST period: 05:00 <= t < 09:30 ----------
          rest_start_hour=5
          rest_start_minute=0
          rest_end_hour=9
          rest_end_minute=30

          # ---------- SEND STOP if in rest period and not sent ----------
          if ! has_flag_for_today "stop_sent" && { [ $current_hour_iran -gt $rest_start_hour ] || { [ $current_hour_iran -eq $rest_start_hour ] && [ $current_minute_iran -ge $rest_start_minute ]; } } && { [ $current_hour_iran -lt $rest_end_hour ] || { [ $current_hour_iran -eq $rest_end_hour ] && [ $current_minute_iran -lt $rest_end_minute ]; } }; then
            echo "Sending STOP message (rest period active)..."
            curl -s -G --data-urlencode "phone=$phone" \
                  --data-urlencode "text=üõë Bot stopped monitoring for rest period (05:00‚Äì09:30)." \
                  --data-urlencode "apikey=$apikey" \
                  "https://api.callmebot.com/whatsapp.php" || true
            write_flag_for_today "stop_sent"
            echo "Rest window active ‚Äî exiting."
            exit 0
          fi

          # ---------- SEND START if rest period ended and not sent ----------
          if ! has_flag_for_today "start_sent" && { [ $current_hour_iran -gt $rest_end_hour ] || { [ $current_hour_iran -eq $rest_end_hour ] && [ $current_minute_iran -ge $rest_end_minute ]; } }; then
            echo "Sending START message (rest period ended)..."
            curl -s -G --data-urlencode "phone=$phone" \
                  --data-urlencode "text=üöÄ Bot started monitoring after rest period (~09:30 Iran time)." \
                  --data-urlencode "apikey=$apikey" \
                  "https://api.callmebot.com/whatsapp.php" || true
            write_flag_for_today "start_sent"
          fi

          echo "Active hours confirmed ‚Äî running site checks now."

          # ---------- sites list ----------
          sites=(
            "https://n8n-vn5b.onrender.com/"
            "https://cl-s5ej.onrender.com/"
            "https://bitbrief.click/"
            "https://trrigeractive.onrender.com/"
            "https://n8nyoutube-ullx.onrender.com/"
            "https://n8nrunner.onrender.com/"
            "https://kadoo.click/"
            "https://crawl-f2mb.onrender.com/"
            "https://server2-sy6g.onrender.com/health"
            "https://neurobackend.onrender.com/"
            "https://license-krks.onrender.com/"
            "https://api1-nsqh.onrender.com/"
          )

          summary="üìä Daily Render Status Report ($iran_date):\n\n"
          MAX_ATTEMPTS=10
          SLEEP_BETWEEN=15

          # ---------- iterate sites ----------
          for site in "${sites[@]}"; do
            echo "Checking: $site"
            attempts=0
            success=false
            while [ $attempts -lt $MAX_ATTEMPTS ]; do
              attempts=$((attempts+1))
              if curl -s -I -m 10 "$site" | grep -q -E "HTTP/[0-9.]+ (200|301|302)"; then
                success=true
                echo "  -> UP (after $attempts try)"
                break
              else
                echo "  -> attempt $attempts failed, sleeping ${SLEEP_BETWEEN}s..."
                sleep $SLEEP_BETWEEN
              fi
            done
            grep -v "^$site " "$state_file" > "$state_file.tmp" || true
            mv "$state_file.tmp" "$state_file" || true
            if [ "$success" = true ]; then
              echo "$site up" >> "$state_file"
              summary+="$site ‚Üí ‚úÖ UP (after ${attempts} try)\n"
            else
              echo "$site down" >> "$state_file"
              summary+="$site ‚Üí ‚ùå DOWN (after ${attempts} tries)\n"
            fi
          done

          # ---------- DAILY SUMMARY at 23:50 Iran (one-time) ----------
          if [ "$current_hour_iran" -eq 23 ] && [ $current_minute_iran -ge 50 ]; then
            if ! has_flag_for_today "daily_sent"; then
              echo "Sending daily summary..."
              curl -s -G --data-urlencode "phone=$phone" \
                    --data-urlencode "text=$summary" \
                    --data-urlencode "apikey=$apikey" \
                    "https://api.callmebot.com/whatsapp.php" || true
              write_flag_for_today "daily_sent"
            else
              echo "Daily summary already sent today."
            fi
          else
            echo "Not time for daily summary yet."
          fi

      - name: Save cache and flags
        uses: actions/cache@v3
        with:
          path: .cache
          key: site-status-${{ runner.os }}-v2
