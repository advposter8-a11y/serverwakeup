name: Wake Render Sites (Smart Start/Stop)

on:
  schedule:
    - cron: '*/30 * * * *'   # Ÿáÿ± €≥€∞ ÿØŸÇ€åŸÇŸá (UTC)
  workflow_dispatch: {}

concurrency:
  group: wake-render
  cancel-in-progress: true

jobs:
  wake:
    runs-on: ubuntu-latest

    steps:
      - name: Restore state cache
        uses: actions/cache@v3
        with:
          path: .cache/
          key: site-state-${{ runner.os }}-v4
          restore-keys: |
            site-state-${{ runner.os }}-v4

      - name: Wake Render Sites with Smart Timing
        run: |
          set -e
          mkdir -p .cache
          state_file=".cache/site_status.log"
          touch "$state_file"

          # üïí ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ÿ≥ÿßÿπÿ™ ÿß€åÿ±ÿßŸÜ (UTC+3:30)
          current_utc_hour=$(date -u +"%H")
          current_utc_minute=$(date -u +"%M")
          total_utc_minutes=$((10#$current_utc_hour * 60 + 10#$current_utc_minute))
          total_iran_minutes=$(( (total_utc_minutes + 210) % 1440 ))

          iran_hour=$((total_iran_minutes / 60))
          iran_minute=$((total_iran_minutes % 60))
          printf "üïí Iran time: %02d:%02d\n" $iran_hour $iran_minute

          # üåê ŸÑ€åÿ≥ÿ™ ÿ≥ÿß€åÿ™‚ÄåŸáÿß
          sites=(
            "https://puppeteer-18ko.onrender.com/health"
            "https://n8n-vn5b.onrender.com/"
            "https://cl-s5ej.onrender.com/"
            "https://bitbrief.click/"
            "https://trrigeractive.onrender.com/"
            "https://n8nyoutube-ullx.onrender.com/"
            "https://n8nrunner.onrender.com/"
            "https://kadoo.click/"
            "https://crawl-f2mb.onrender.com/"
            "https://server2-sy6g.onrender.com/health"
            "https://neurobackend.onrender.com/"
            "https://license-krks.onrender.com/"
            "https://api1-nsqh.onrender.com/"
            "https://bitbriefclawl.onrender.com/health"
            "https://indexkadoo.onrender.com/health"
            "https://bitbriefclawl.onrender.com/crawl-bitbrief"
            "https://indexkadoo.onrender.com/crawl-kadoo"
          )

          # üí§ ÿ®ÿßÿ≤Ÿá ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ™: 05:00‚Äì09:30 ÿß€åÿ±ÿßŸÜ
          start_minutes=$((9 * 60 + 30))
          stop_minutes=$((5 * 60))

          if [ $total_iran_minutes -ge $stop_minutes ] && [ $total_iran_minutes -lt $start_minutes ]; then
            echo "üò¥ Sleep mode (05:00‚Äì09:30 Iran). Skipping all checks."
            exit 0
          fi

          echo "üü¢ Active hours. Checking & waking sites..."

          MAX_ATTEMPTS=15

          for site in "${sites[@]}"; do
            echo "üîπ Checking $site"
            success=false

            for i in $(seq 1 $MAX_ATTEMPTS); do
              echo "   attempt $i/$MAX_ATTEMPTS"

              status_code=$(curl -s -o /dev/null \
                --connect-timeout 5 \
                --max-time 8 \
                -w "%{http_code}" "$site" || echo "000")

              body_preview=$(curl -s \
                --connect-timeout 5 \
                --max-time 8 \
                "$site" 2>/dev/null | head -n 3 || true)

              if [[ "$status_code" =~ ^(200|301|302)$ ]] \
                 && [[ ! "$body_preview" =~ "Render Internal Error" ]] \
                 && [[ ! "$body_preview" =~ "starting" ]] \
                 && [[ ! "$body_preview" =~ "Booting" ]]; then
                success=true
                break
              fi

              sleep 10
            done

            if [ "$success" = true ]; then
              echo "$site ‚Üí ‚úÖ UP"
            else
              echo "$site ‚Üí ‚ùå DOWN (wake attempts failed)"
            fi
          done

      - name: Save cache
        uses: actions/cache@v3
        with:
          path: .cache/
          key: site-state-${{ runner.os }}-v4
