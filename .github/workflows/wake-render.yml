import requests, time, datetime, pytz, sys

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ
SITES = ["https://n8n-vn5b.onrender.com/"]
MAX_ATTEMPTS = 15
CHECK_INTERVAL = 30  # Ø«Ø§Ù†ÛŒÙ‡
TIMEZONE = pytz.timezone("Asia/Tehran")

# Ù…Ø­Ø¯ÙˆØ¯Ù‡â€ŒÛŒ Ø²Ù…Ø§Ù†ÛŒ ÙØ¹Ø§Ù„ Ùˆ ØºÛŒØ±ÙØ¹Ø§Ù„
ACTIVE_START = (9, 30)
ACTIVE_END = (23, 55)
STOP_WINDOW = [(5, 0), (5, 4)]

def iran_time():
    return datetime.datetime.now(TIMEZONE)

def is_in_time_range(start, end):
    now = iran_time().time()
    return start <= now <= end

def send_status(msg):
    print(msg)
    sys.stdout.flush()

def check_site_status(url):
    """Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø§ÛŒØª Ø¨Ø§ Ù¾Ø§Ø³Ø® Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±"""
    try:
        r = requests.get(url, timeout=10)
        if r.status_code == 200:
            # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ØªÙˆØ§ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ ÙˆØ§Ù‚Ø¹Ø§ Ø³Ø§ÛŒØª Ø¨Ø§Ù„Ø§ Ø¢Ù…Ø¯Ù‡
            if "error" not in r.text.lower() and len(r.text) > 50:
                return True
        return False
    except Exception:
        return False

def wake_sites():
    for site in SITES:
        send_status(f"ğŸ”¹ Checking {site}")
        attempts = 0
        while attempts < MAX_ATTEMPTS:
            if check_site_status(site):
                send_status(f"âœ… {site} is UP after {attempts+1} tries\n")
                break
            attempts += 1
            time.sleep(CHECK_INTERVAL)
        else:
            send_status(f"âŒ {site} FAILED to wake after {MAX_ATTEMPTS} tries\n")

def main():
    now = iran_time()
    time_str = now.strftime("%H:%M")
    send_status(f"\nğŸ•’ Iran time: {time_str}")

    # Ø¨Ø§Ø²Ù‡ ØªÙˆÙ‚Ù
    if is_in_time_range(*STOP_WINDOW[0]) or is_in_time_range(*STOP_WINDOW[-1]):
        send_status("ğŸŸ¥ Stop window (05:00â€“05:04) â†’ Sending STOP message")
        return

    # Ø³Ø§Ø¹Øª ÙØ¹Ø§Ù„
    if is_in_time_range(datetime.time(*ACTIVE_START), datetime.time(*ACTIVE_END)):
        send_status("ğŸŸ¢ Active hours. Checking site status...\n")
        wake_sites()
    else:
        send_status("âšª Inactive hours. Waiting for next schedule.\n")

if __name__ == "__main__":
    main()
