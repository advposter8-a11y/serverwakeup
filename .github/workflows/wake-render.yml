name: Wake Render Sites (WhatsApp Alerts + Recovery)

on:
  schedule:
    - cron: '15 6-21/2 * * *'  # Ø§Ø² 9:15 ØµØ¨Ø­ ØªØ§ 5 ØµØ¨Ø­ Ø§ÛŒØ±Ø§Ù† (UTC 06:15 ØªØ§ 21:15)
  workflow_dispatch: {}  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø² GitHub Actions

jobs:
  wake:
    runs-on: ubuntu-latest
    steps:
      - name: Wake and Monitor Render Sites
        run: |
          echo "=== Render Wake Script with WhatsApp Alerts and Recovery ==="
          current_hour=$(date -u +"%H")

          # ÙÙ‚Ø· Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡Ù” Ù…Ø¬Ø§Ø² (Û¶ ØªØ§ Û²Û± UTC â‰ˆ Û¹:Û±Ûµ ØªØ§ Ûµ ØµØ¨Ø­ Ø§ÛŒØ±Ø§Ù†)
          if [ $current_hour -ge 6 ] && [ $current_hour -le 21 ]; then
            echo "ðŸŸ¢ Inside active hours, checking Render sites..."

            # Ù„ÛŒØ³Øª Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§
            sites=(
              "https://n8n-vn5b.onrender.com/"
              "https://cl-s5ej.onrender.com/"
              "https://bitbrief.click/"
              "https://trrigeractive.onrender.com/"
              "https://n8nyoutube-ullx.onrender.com/"
              "https://n8nrunner.onrender.com/"
              "https://kadoo.click/"
              "https://crawl-f2mb.onrender.com/"
              "https://server2-sy6g.onrender.com/health"
              "https://neurobackend.onrender.com/"
              "https://license-krks.onrender.com/"
              "https://api1-nsqh.onrender.com/"
            )

            # Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§ØªØ³Ø§Ù¾ Ø§Ø² CallMeBot
            phone="989197934854"
            apikey="4287648"

            # Ù…Ø³ÛŒØ± Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø¨Ø§Ø²Ú¯Ø´Øª Ø³Ø±ÙˆØ±
            mkdir -p .cache
            state_file=".cache/site_status.log"
            touch "$state_file"

            for site in "${sites[@]}"; do
              echo "ðŸ”¹ Checking $site"
              success=false
              for i in {1..10}; do
                echo "Try #$i for $site"
                if curl -s -I "$site" | grep -q "200\|301\|302"; then
                  echo "$site is awake âœ…"
                  success=true
                  break
                fi
                echo "Sleeping 15s before retry..."
                sleep 15
              done

              # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ùˆ Ù‚Ø¨Ù„ÛŒ
              prev_status=$(grep "^$site " "$state_file" | awk '{print $2}')
              if [ "$success" = true ]; then
                # Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Down Ø¨ÙˆØ¯Ù‡ØŒ Ø§Ù„Ø§Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡Ø¨ÙˆØ¯ÛŒ Ø¨ÙØ±Ø³Øª
                if [ "$prev_status" = "down" ]; then
                  msg="âœ… $site is back online!"
                  echo "Sending recovery alert: $msg"
                  curl -G --data-urlencode "phone=$phone" \
                          --data-urlencode "text=$msg" \
                          --data-urlencode "apikey=$apikey" \
                          "https://api.callmebot.com/whatsapp.php"
                fi
                # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ up
                grep -v "^$site " "$state_file" > "$state_file.tmp" && mv "$state_file.tmp" "$state_file"
                echo "$site up" >> "$state_file"
              else
                echo "âš ï¸ $site did not wake up after 10 tries."
                # Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ up Ø¨ÙˆØ¯Ù‡ØŒ Ø§Ù„Ø§Ù† Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¨ÙØ±Ø³Øª
                if [ "$prev_status" != "down" ]; then
                  msg="âš ï¸ Render site DOWN: $site"
                  echo "Sending alert: $msg"
                  curl -G --data-urlencode "phone=$phone" \
                          --data-urlencode "text=$msg" \
                          --data-urlencode "apikey=$apikey" \
                          "https://api.callmebot.com/whatsapp.php"
                fi
                # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ down
                grep -v "^$site " "$state_file" > "$state_file.tmp" && mv "$state_file.tmp" "$state_file"
                echo "$site down" >> "$state_file"
              fi
            done

          else
            echo "ðŸ›Œ Outside active hours (5:00â€“9:15). Skipping wake-up checks."
          fi
